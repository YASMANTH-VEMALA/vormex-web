{"version":3,"sources":["../../../../src/app/auth/google/callback/page.tsx"],"sourcesContent":["'use client';\n\nimport { useEffect, useState, Suspense } from 'react';\nimport { useRouter, useSearchParams } from 'next/navigation';\nimport { authAPI } from '@/lib/api/auth';\nimport { useAuthContext } from '@/lib/auth/authContext';\nimport { setPendingUser } from '@/lib/auth/authHelpers';\nimport { handleApiError } from '@/lib/utils/errorHandler';\nimport '../../../login/login.css';\n\nfunction GoogleCallbackContent() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const { setAuth } = useAuthContext();\n  const [error, setError] = useState<string | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n\n  useEffect(() => {\n    const handleCallback = async () => {\n      try {\n        // Get authorization code and state from URL\n        const code = searchParams.get('code');\n        const state = searchParams.get('state');\n        const errorParam = searchParams.get('error');\n\n        // Check for OAuth errors\n        if (errorParam) {\n          setError(`Google OAuth error: ${errorParam}`);\n          setIsLoading(false);\n          setTimeout(() => router.push('/login'), 3000);\n          return;\n        }\n\n        // Validate state (CSRF protection)\n        const storedState = sessionStorage.getItem('oauth_state');\n        if (!state || state !== storedState) {\n        setError('Invalid state parameter. Please try again.');\n        setIsLoading(false);\n        sessionStorage.removeItem('oauth_state');\n        sessionStorage.removeItem('oauth_code_verifier');\n        setTimeout(() => router.push('/login'), 3000);\n        return;\n      }\n\n      if (!code) {\n        setError('Authorization code not found. Please try again.');\n        setIsLoading(false);\n        sessionStorage.removeItem('oauth_state');\n        sessionStorage.removeItem('oauth_code_verifier');\n        setTimeout(() => router.push('/login'), 3000);\n        return;\n      }\n\n        // Exchange authorization code for tokens using PKCE via our API route\n        const redirectUri = `${window.location.origin}/auth/google/callback`;\n        const codeVerifier = sessionStorage.getItem('oauth_code_verifier');\n        \n        if (!codeVerifier) {\n          throw new Error('Code verifier not found. Please try signing in again.');\n        }\n\n        // Use our API route to exchange code for tokens (server-side, secure)\n        const tokenResponse = await fetch('/api/auth/google/callback', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\n            code: code,\n            codeVerifier: codeVerifier,\n            redirectUri: redirectUri,\n          }),\n        });\n\n        if (!tokenResponse.ok) {\n          const errorData = await tokenResponse.json().catch(() => ({}));\n          throw new Error(errorData.error || errorData.error_description || 'Failed to exchange authorization code');\n        }\n\n        const tokenData = await tokenResponse.json();\n\n        // Extract id_token from the response\n        const idToken = tokenData.idToken;\n\n        if (!idToken) {\n          throw new Error('ID token not found in token response');\n        }\n\n        // Send id_token to backend\n        const authResponse = await authAPI.googleSignIn(idToken);\n\n        setAuth(authResponse);\n        setPendingUser(authResponse.user);\n\n        sessionStorage.removeItem('oauth_state');\n        sessionStorage.removeItem('oauth_code_verifier');\n\n        window.location.replace('/');\n      } catch (err) {\n        console.error('Google OAuth callback error:', err);\n        setError(handleApiError(err));\n        setIsLoading(false);\n        sessionStorage.removeItem('oauth_state');\n        sessionStorage.removeItem('oauth_code_verifier');\n        setTimeout(() => router.push('/login'), 3000);\n      }\n    };\n\n    handleCallback();\n  }, [searchParams, router, setAuth]);\n\n  return (\n    <div className=\"auth-page-wrapper\">\n      <div className=\"main\" style={{ maxWidth: '500px', width: '100%' }}>\n        <div className=\"form\">\n          <h2 className=\"form_title title\">Signing in with Google...</h2>\n          {isLoading && (\n            <p className=\"description\" style={{ marginTop: '20px' }}>\n              Please wait while we complete your sign-in.\n            </p>\n          )}\n          {error && (\n            <>\n              <div className=\"error-message\" style={{ marginTop: '20px' }}>\n                {error}\n              </div>\n              <p className=\"description\" style={{ marginTop: '10px' }}>\n                Redirecting to login page...\n              </p>\n            </>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default function GoogleCallbackPage() {\n  return (\n    <Suspense fallback={\n      <div className=\"auth-page-wrapper\">\n        <div className=\"main\" style={{ maxWidth: '500px', width: '100%' }}>\n          <div className=\"form\">\n            <h2 className=\"form_title title\">Signing in with Google...</h2>\n            <p className=\"description\" style={{ marginTop: '20px' }}>\n              Loading...\n            </p>\n          </div>\n        </div>\n      </div>\n    }>\n      <GoogleCallbackContent />\n    </Suspense>\n  );\n}\n\n"],"names":[],"mappings":"wDAEA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAGA,SAAS,IACP,IAAM,EAAS,CAAA,EAAA,EAAA,SAAA,AAAS,IAClB,EAAe,CAAA,EAAA,EAAA,eAAA,AAAe,IAC9B,SAAE,CAAO,CAAE,CAAG,CAAA,EAAA,EAAA,cAAc,AAAd,IACd,CAAC,EAAO,EAAS,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAgB,MAC5C,CAAC,EAAW,EAAa,CAAG,CAAA,EAAA,EAAA,QAAQ,AAAR,GAAS,GAgG3C,MA9FA,CAAA,EAAA,EAAA,SAAA,AAAS,EAAC,KA2FR,CA1FuB,UACrB,GAAI,CAEF,IAAM,EAAO,EAAa,GAAG,CAAC,QACxB,EAAQ,EAAa,GAAG,CAAC,SACzB,EAAa,EAAa,GAAG,CAAC,SAGpC,GAAI,EAAY,CACd,EAAS,CAAC,oBAAoB,EAAE,EAAA,CAAY,EAC5C,GAAa,GACb,WAAW,IAAM,EAAO,IAAI,CAAC,UAAW,KACxC,MACF,CAGA,IAAM,EAAc,eAAe,OAAO,CAAC,eAC3C,GAAI,CAAC,GAAS,IAAU,EAAa,CACrC,EAAS,8CACT,GAAa,GACb,eAAe,UAAU,CAAC,eAC1B,eAAe,UAAU,CAAC,uBAC1B,WAAW,IAAM,EAAO,IAAI,CAAC,UAAW,KACxC,MACF,CAEA,GAAI,CAAC,EAAM,CACT,EAAS,mDACT,GAAa,GACb,eAAe,UAAU,CAAC,eAC1B,eAAe,UAAU,CAAC,uBAC1B,WAAW,IAAM,EAAO,IAAI,CAAC,UAAW,KACxC,MACF,CAGE,IAAM,EAAc,CAAA,EAAG,OAAO,QAAQ,CAAC,MAAM,CAAC,qBAAqB,CAAC,CAC9D,EAAe,eAAe,OAAO,CAAC,uBAE5C,GAAI,CAAC,EACH,MAAM,AAAI,MADO,AACD,yDAIlB,IAAM,EAAgB,MAAM,MAAM,4BAA6B,CAC7D,OAAQ,OACR,QAAS,CACP,eAAgB,kBAClB,EACA,KAAM,KAAK,SAAS,CAAC,CACnB,KAAM,EACN,aAAc,EACd,YAAa,CACf,EACF,GAEA,GAAI,CAAC,EAAc,EAAE,CAAE,CACrB,IAAM,EAAY,MAAM,EAAc,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC,EAC5D,OAAM,AAAI,MAAM,EAAU,KAAK,EAAI,EAAU,iBAAiB,EAAI,wCACpE,CAKA,IAAM,EAAU,CAHE,MAAM,EAAc,IAAI,EAAA,EAGhB,OAAO,CAEjC,GAAI,CAAC,EACH,MAAM,AAAI,CADE,KACI,wCAIlB,IAAM,EAAe,MAAM,EAAA,OAAO,CAAC,YAAY,CAAC,GAEhD,EAAQ,GACR,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,EAAa,IAAI,EAEhC,eAAe,UAAU,CAAC,eAC1B,eAAe,UAAU,CAAC,uBAE1B,OAAO,QAAQ,CAAC,OAAO,CAAC,IAC1B,CAAE,MAAO,EAAK,CACZ,QAAQ,KAAK,CAAC,+BAAgC,GAC9C,EAAS,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,IACxB,GAAa,GACb,eAAe,UAAU,CAAC,eAC1B,eAAe,UAAU,CAAC,uBAC1B,WAAW,IAAM,EAAO,IAAI,CAAC,UAAW,IAC1C,EACF,GAGF,EAAG,CAAC,EAAc,EAAQ,EAAQ,EAGhC,CAAA,EAAA,EAAA,GAAA,EAAC,MAAA,CAAI,UAAU,6BACb,CAAA,EAAA,EAAA,GAAA,EAAC,MAAA,CAAI,UAAU,OAAO,MAAO,CAAE,SAAU,QAAS,MAAO,MAAO,WAC9D,CAAA,EAAA,EAAA,IAAA,EAAC,MAAA,CAAI,UAAU,iBACb,CAAA,EAAA,EAAA,GAAA,EAAC,KAAA,CAAG,UAAU,4BAAmB,8BAChC,GACC,CAAA,EAAA,EAAA,GAAA,EAAC,IAAA,CAAE,UAAU,cAAc,MAAO,CAAE,UAAW,MAAO,WAAG,gDAI1D,GACC,CAAA,EAAA,EAAA,IAAA,EAAA,EAAA,QAAA,CAAA,WACE,CAAA,EAAA,EAAA,GAAA,EAAC,MAAA,CAAI,UAAU,gBAAgB,MAAO,CAAE,UAAW,MAAO,WACvD,IAEH,CAAA,EAAA,EAAA,GAAA,EAAC,IAAA,CAAE,UAAU,cAAc,MAAO,CAAE,UAAW,MAAO,WAAG,0CASvE,CAEe,SAAS,IACtB,MACE,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,QAAQ,CAAA,CAAC,SACR,CAAA,EAAA,EAAA,GAAA,EAAC,MAAA,CAAI,UAAU,6BACb,CAAA,EAAA,EAAA,GAAA,EAAC,MAAA,CAAI,UAAU,OAAO,MAAO,CAAE,SAAU,QAAS,MAAO,MAAO,WAC9D,CAAA,EAAA,EAAA,IAAA,EAAC,MAAA,CAAI,UAAU,iBACb,CAAA,EAAA,EAAA,GAAA,EAAC,KAAA,CAAG,UAAU,4BAAmB,8BACjC,CAAA,EAAA,EAAA,GAAA,EAAC,IAAA,CAAE,UAAU,cAAc,MAAO,CAAE,UAAW,MAAO,WAAG,+BAO/D,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,CAAA,IAGP"}
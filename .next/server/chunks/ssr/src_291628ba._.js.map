{"version":3,"sources":["../../../../src/lib/api/store.ts","../../../../src/app/messages/%5BconversationId%5D/page.tsx"],"sourcesContent":["import apiClient from './client';\n\nexport interface StoreItem {\n  id: string;\n  slug: string;\n  name: string;\n  description?: string;\n  imageUrl?: string;\n  category: string;\n  type: string;\n  xpCost: number;\n  isFeatured?: boolean;\n  metadata?: Record<string, unknown>;\n  isActive: boolean;\n  stock?: number;\n  createdAt?: string;\n  updatedAt?: string;\n}\n\nexport interface StoreCategoryCount {\n  category: string;\n  count: number;\n}\n\nexport interface StorePurchase {\n  id: string;\n  userId: string;\n  itemId: string;\n  item: StoreItem;\n  xpSpent: number;\n  purchasedAt: string;\n}\n\nexport interface UserInventory {\n  id: string;\n  userId: string;\n  itemType: string;\n  itemSlug: string;\n  isEquipped: boolean;\n  acquiredAt: string;\n  item?: StoreItem;\n}\n\n// Get all store items\nexport const getStoreItems = async (category?: string): Promise<StoreItem[]> => {\n  const response = await apiClient.get('/store/items', { params: { category } });\n  return response.data;\n};\n\n// Get store item by slug\nexport const getStoreItem = async (slug: string): Promise<StoreItem> => {\n  const response = await apiClient.get(`/store/items/${slug}`);\n  return response.data;\n};\n\n// Get store categories\nexport const getStoreCategories = async (): Promise<StoreCategoryCount[]> => {\n  const response = await apiClient.get('/store/categories');\n  return response.data;\n};\n\n// Purchase an item\nexport const purchaseItem = async (itemSlug: string) => {\n  const response = await apiClient.post('/store/purchase', { itemSlug });\n  return response;\n};\n\n// Get my inventory\nexport const getMyInventory = async (): Promise<UserInventory[]> => {\n  const response = await apiClient.get('/store/inventory');\n  // Ensure we always return an array, even if backend returns null/undefined\n  return Array.isArray(response.data) ? response.data : [];\n};\n\n// Get my purchase history\nexport const getMyPurchases = async (): Promise<StorePurchase[]> => {\n  const response = await apiClient.get('/store/history');\n  return response.data;\n};\n\n// Activate an item\nexport const activateItem = async (inventoryId: string) => {\n  const response = await apiClient.post(`/store/inventory/${inventoryId}/activate`);\n  return response;\n};\n\n// Get my XP balance\nexport const getXPBalance = async (): Promise<number> => {\n  const response = await apiClient.get('/store/balance');\n  return response.data?.balance ?? response.data ?? 0;\n};\n\n// Get purchase history\nexport const getPurchaseHistory = async (): Promise<StorePurchase[]> => {\n  const response = await apiClient.get('/store/purchases');\n  return response.data;\n};\n","'use client';\n\nimport { useEffect, useState, use, useCallback } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { useAuth } from '@/lib/auth/useAuth';\nimport { ChatMessages, ChatInput, ChatHeader, type UploadingMessage, type OptimisticMessage } from '@/components/chat';\nimport ChatSettingsPanel from '@/components/chat/ChatSettingsPanel';\nimport { getConversation, Conversation } from '@/lib/api/chat';\nimport { initializeSocket } from '@/lib/socket';\nimport * as storeAPI from '@/lib/api/store';\nimport {\n  buildChatCustomizationEntitlements,\n  DEFAULT_CHAT_CUSTOMIZATION_ENTITLEMENTS,\n  isWallpaperUnlocked,\n} from '@/lib/chat/customization';\n\ninterface ConversationPageProps {\n  params: Promise<{ conversationId: string }>;\n}\n\n// This page only renders the chat area - the layout.tsx handles the sidebar with ChatList\nexport default function ConversationPage({ params }: ConversationPageProps) {\n  const resolvedParams = use(params);\n  const router = useRouter();\n  const { user } = useAuth();\n  const [conversation, setConversation] = useState<Conversation | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [replyTo, setReplyTo] = useState<{ id: string; content: string; senderName: string } | null>(null);\n  const [showSettings, setShowSettings] = useState(false);\n  const [wallpaper, setWallpaper] = useState('default');\n  const [uploadingMessages, setUploadingMessages] = useState<UploadingMessage[]>([]);\n  const [optimisticMessages, setOptimisticMessages] = useState<OptimisticMessage[]>([]);\n  const [lastReceivedMessage, setLastReceivedMessage] = useState<string>('');\n  const [chatCustomization, setChatCustomization] = useState(DEFAULT_CHAT_CUSTOMIZATION_ENTITLEMENTS);\n\n  // Callback to track the last message received from other user\n  const handleLastMessageUpdate = useCallback((message: string) => {\n    setLastReceivedMessage(message);\n  }, []);\n\n  // Handle optimistic message - add to list for immediate display\n  const handleOptimisticMessage = useCallback((message: OptimisticMessage) => {\n    setOptimisticMessages(prev => [...prev, message]);\n  }, []);\n\n  // Remove optimistic messages when real messages arrive\n  const handleMessageConfirmed = useCallback((confirmedContent: string) => {\n    // Remove the first optimistic message with matching content\n    setOptimisticMessages(prev => {\n      const idx = prev.findIndex(m => m.content === confirmedContent);\n      if (idx >= 0) {\n        const updated = [...prev];\n        updated.splice(idx, 1);\n        return updated;\n      }\n      return prev;\n    });\n  }, []);\n\n  // Load wallpaper preference from localStorage\n  useEffect(() => {\n    if (resolvedParams.conversationId) {\n      const savedWallpaper = localStorage.getItem(`chat_wallpaper_${resolvedParams.conversationId}`);\n      if (savedWallpaper) {\n        setWallpaper(savedWallpaper);\n      } else {\n        setWallpaper('default');\n      }\n    }\n  }, [resolvedParams.conversationId]);\n\n  // Load purchased chat customization packs from inventory\n  useEffect(() => {\n    const loadChatCustomization = async () => {\n      if (!user?.id) return;\n\n      try {\n        const inventory = await storeAPI.getMyInventory();\n        // Handle case where inventory is undefined or not an array\n        const ownedSlugs = Array.isArray(inventory) ? inventory.map((item) => item.itemSlug) : [];\n        setChatCustomization(buildChatCustomizationEntitlements(ownedSlugs));\n      } catch (error) {\n        console.error('Failed to load chat customization packs:', error);\n        setChatCustomization(DEFAULT_CHAT_CUSTOMIZATION_ENTITLEMENTS);\n      }\n    };\n\n    loadChatCustomization();\n  }, [user?.id]);\n\n  // If current wallpaper is locked and user no longer owns required pack, fallback to default\n  useEffect(() => {\n    if (!isWallpaperUnlocked(wallpaper, chatCustomization.ownedThemePacks)) {\n      setWallpaper('default');\n      localStorage.setItem(`chat_wallpaper_${resolvedParams.conversationId}`, 'default');\n    }\n  }, [wallpaper, chatCustomization.ownedThemePacks, resolvedParams.conversationId]);\n\n  // Save wallpaper preference\n  const handleWallpaperChange = (newWallpaper: string) => {\n    setWallpaper(newWallpaper);\n    localStorage.setItem(`chat_wallpaper_${resolvedParams.conversationId}`, newWallpaper);\n  };\n\n  // Initialize socket\n  useEffect(() => {\n    if (user?.id) {\n      initializeSocket();\n    }\n  }, [user?.id]);\n\n  // Fetch conversation\n  useEffect(() => {\n    const fetchConversation = async () => {\n      try {\n        setLoading(true);\n        setError(null);\n        const conv = await getConversation(resolvedParams.conversationId);\n        setConversation(conv);\n        // Clear reply, uploading and optimistic messages when switching conversations\n        setReplyTo(null);\n        setUploadingMessages([]);\n        setOptimisticMessages([]);\n      } catch (err: unknown) {\n        setError(err instanceof Error ? err.message : 'Failed to load conversation');\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    if (resolvedParams.conversationId && user?.id) {\n      fetchConversation();\n    }\n  }, [resolvedParams.conversationId, user?.id]);\n\n  const handleBack = () => {\n    router.push('/messages');\n  };\n\n  const otherUser = conversation?.otherParticipant;\n\n  // Loading state\n  if (loading) {\n    return (\n      <div className=\"flex-1 flex items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600\"></div>\n      </div>\n    );\n  }\n\n  // Error state\n  if (error || !conversation || !otherUser) {\n    return (\n      <div className=\"flex-1 flex items-center justify-center\">\n        <div className=\"text-center\">\n          <p className=\"text-red-500 mb-4\">{error || 'Conversation not found'}</p>\n          <button\n            onClick={handleBack}\n            className=\"text-blue-600 hover:underline\"\n          >\n            Go back to messages\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <>\n      <div className=\"flex-1 flex flex-col h-full overflow-hidden\">\n        {/* Chat Header */}\n        <ChatHeader \n          user={otherUser}\n          conversationId={resolvedParams.conversationId}\n          onBack={handleBack}\n          onInfo={() => setShowSettings(true)}\n        />\n\n        {/* Messages */}\n        <ChatMessages\n          key={resolvedParams.conversationId}\n          conversationId={resolvedParams.conversationId}\n          currentUserId={user!.id}\n          otherUser={otherUser}\n          wallpaper={wallpaper}\n          availableReactions={chatCustomization.availableReactions}\n          animatedBubbles={chatCustomization.animatedBubbles}\n          onReply={(msg) => setReplyTo(msg)}\n          uploadingMessages={uploadingMessages}\n          optimisticMessages={optimisticMessages}\n          onLastMessageUpdate={handleLastMessageUpdate}\n          onMessageConfirmed={handleMessageConfirmed}\n        />\n\n        {/* Input */}\n        <ChatInput\n          key={`input-${resolvedParams.conversationId}`}\n          conversationId={resolvedParams.conversationId}\n          currentUserId={user!.id}\n          replyTo={replyTo || undefined}\n          onCancelReply={() => setReplyTo(null)}\n          onUploadingMessagesChange={setUploadingMessages}\n          onOptimisticMessage={handleOptimisticMessage}\n          otherUserId={otherUser.id}\n          otherUserName={otherUser.name}\n          lastReceivedMessage={lastReceivedMessage}\n          enabledMessageEffects={chatCustomization.messageEffects}\n        />\n      </div>\n\n      {/* Settings Panel */}\n      <ChatSettingsPanel\n        key={`settings-${resolvedParams.conversationId}`}\n        isOpen={showSettings}\n        onClose={() => setShowSettings(false)}\n        conversationId={resolvedParams.conversationId}\n        otherUser={otherUser}\n        currentWallpaper={wallpaper}\n        onWallpaperChange={handleWallpaperChange}\n        ownedThemePacks={chatCustomization.ownedThemePacks}\n        onOpenStore={() => router.push('/store')}\n      />\n    </>\n  );\n}\n"],"names":[],"mappings":"uCAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OA4CO,IAAM,EAAgB,MAAO,GAE3B,CADU,MAAM,EAAA,OAAS,CAAC,GAAG,CAAC,eAAgB,CAAE,OAAQ,UAAE,CAAS,CAAE,EAAA,EAC5D,IAAI,CAgBT,EAAe,MAAO,GAChB,MAAM,EAAA,OAAS,CAAC,IAAI,CAAC,kBAAmB,UAAE,CAAS,GAKzD,EAAiB,UAC5B,IAAM,EAAW,MAAM,EAAA,OAAS,CAAC,GAAG,CAAC,oBAErC,OAAO,MAAM,OAAO,CAAC,EAAS,IAAI,EAAI,EAAS,IAAI,CAAG,EAAE,AAC1D,EAGa,EAAiB,SAErB,CADU,MAAM,EAAA,OAAS,CAAC,GAAG,CAAC,iBAAA,EACrB,IAAI,CAUT,EAAe,UAC1B,IAAM,EAAW,MAAM,EAAA,OAAS,CAAC,GAAG,CAAC,kBACrC,OAAO,EAAS,IAAI,EAAE,SAAW,EAAS,IAAI,EAAI,CACpD,sJCxFA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,MACA,EAAA,CAAA,CAAA,8DACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAWe,SAAS,EAAiB,CAAE,QAAM,CAAyB,EACxE,IAAM,EAAiB,CAAA,EAAA,EAAA,GAAA,AAAG,EAAC,GACrB,EAAS,CAAA,EAAA,EAAA,SAAA,AAAS,IAClB,CAAE,MAAI,CAAE,CAAG,CAAA,EAAA,EAAA,OAAA,AAAO,IAClB,CAAC,EAAc,EAAgB,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAsB,MAChE,CAAC,EAAS,EAAW,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,GAAC,GACjC,CAAC,EAAO,EAAS,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAgB,MAC5C,CAAC,EAAS,EAAW,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,EAA6D,MAC7F,CAAC,EAAc,EAAgB,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,GAAC,GAC3C,CAAC,EAAW,EAAa,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,WACrC,CAAC,EAAmB,EAAqB,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAqB,EAAE,EAC3E,CAAC,EAAoB,EAAsB,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAsB,EAAE,EAC9E,CAAC,EAAqB,EAAuB,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAS,IACjE,CAAC,EAAmB,EAAqB,CAAG,CAAA,EAAA,EAAA,QAAQ,AAAR,EAAS,EAAA,uCAAuC,EAG5F,EAA0B,CAAA,EAAA,EAAA,WAAA,AAAW,EAAC,AAAC,IAC3C,EAAuB,EACzB,EAAG,EAAE,EAGC,EAA0B,CAAA,EAAA,EAAA,WAAA,AAAW,EAAC,AAAC,IAC3C,EAAsB,GAAQ,IAAI,EAAM,EAAQ,CAClD,EAAG,EAAE,EAGC,EAAyB,CAAA,EAAA,EAAA,WAAA,AAAW,EAAC,AAAC,IAE1C,EAAsB,IACpB,IAAM,EAAM,EAAK,SAAS,CAAC,GAAK,EAAE,OAAO,GAAK,GAC9C,GAAI,GAAO,EAAG,CACZ,IAAM,EAAU,IAAI,EAAK,CAEzB,OADA,EAAQ,MAAM,CAAC,EAAK,GACb,CACT,CACA,OAAO,CACT,EACF,EAAG,EAAE,EAGL,CAAA,EAAA,EAAA,SAAA,AAAS,EAAC,KACR,GAAI,EAAe,cAAc,CAAE,CACjC,IAAM,EAAiB,aAAa,OAAO,CAAC,CAAC,eAAe,EAAE,EAAe,cAAc,CAAA,CAAE,EACzF,EACF,EAAa,GAEb,EAAa,OAHK,GAKtB,CACF,EAAG,CAAC,EAAe,cAAc,CAAC,EAGlC,CAAA,EAAA,EAAA,SAAA,AAAS,EAAC,KAeR,CAd8B,UAC5B,GAAK,CAAD,EAAO,GAEX,CAFe,EAEX,CACF,IAAM,EAAY,MAAM,EAAA,cAAuB,GAEzC,EAAa,MAAM,OAAO,CAAC,GAAa,EAAU,GAAG,CAAE,AAAD,GAAU,EAAK,QAAQ,EAAI,EAAE,CACzF,EAAqB,CAAA,EAAA,EAAA,kCAAA,AAAkC,EAAC,GAC1D,CAAE,MAAO,EAAO,CACd,QAAQ,KAAK,CAAC,2CAA4C,GAC1D,EAAqB,EAAA,uCAAuC,CAC9D,EACF,GAGF,EAAG,CAAC,GAAM,GAAG,EAGb,CAAA,EAAA,EAAA,SAAA,AAAS,EAAC,KACH,CAAA,EAAA,EAAA,mBAAA,AAAmB,EAAC,EAAW,EAAkB,eAAe,GAAG,CACtE,EAAa,WACb,aAAa,OAAO,CAAC,CAAC,eAAe,EAAE,EAAe,cAAc,CAAA,CAAE,CAAE,WAE5E,EAAG,CAAC,EAAW,EAAkB,eAAe,CAAE,EAAe,cAAc,CAAC,EAShF,CAAA,EAAA,EAAA,SAAA,AAAS,EAAC,KACJ,GAAM,IAAI,AACZ,CAAA,EAAA,EAAA,gBAAA,AAAgB,GAEpB,EAAG,CAAC,GAAM,GAAG,EAGb,CAAA,EAAA,EAAA,SAAA,AAAS,EAAC,KACR,IAAM,EAAoB,UACxB,GAAI,CACF,EAAW,IACX,EAAS,MACT,IAAM,EAAO,MAAM,CAAA,EAAA,EAAA,eAAA,AAAe,EAAC,EAAe,cAAc,EAChE,EAAgB,GAEhB,EAAW,MACX,EAAqB,EAAE,EACvB,EAAsB,EAAE,CAC1B,CAAE,MAAO,EAAc,CACrB,EAAS,aAAe,MAAQ,EAAI,OAAO,CAAG,8BAChD,QAAU,CACR,GAAW,EACb,CACF,EAEI,EAAe,cAAc,EAAI,GAAM,IAAI,AAC7C,GAEJ,EAAG,CAAC,EAAe,cAAc,CAAE,GAAM,GAAG,EAE5C,IAAM,EAAa,KACjB,EAAO,IAAI,CAAC,YACd,EAEM,EAAY,GAAc,wBAGhC,AAAI,EAEA,CAAA,EAAA,EAAA,EAFS,CAET,EAAC,MAAA,CAAI,UAAU,mDACb,CAAA,EAAA,EAAA,GAAA,EAAC,MAAA,CAAI,UAAU,sEAMjB,GAAU,GAAiB,EAiB7B,CAAA,AAjBW,EAiBX,EAAA,IAjBwC,AAiBxC,EAjB4B,AAiB5B,EAAA,QAAA,CAAA,WACE,CAAA,EAAA,EAAA,IAAA,EAAC,MAAA,CAAI,UAAU,wDAEb,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,OAAU,CAAA,CACT,KAAM,EACN,eAAgB,EAAe,cAAc,CAC7C,OAAQ,EACR,OAAQ,IAAM,GAAgB,KAIhC,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,OAAY,CAAA,CAEX,eAAgB,EAAe,cAAc,CAC7C,cAAe,EAAM,EAAE,CACvB,UAAW,EACX,UAAW,EACX,mBAAoB,EAAkB,kBAAkB,CACxD,gBAAiB,EAAkB,eAAe,CAClD,QAAS,AAAC,GAAQ,EAAW,GAC7B,kBAAmB,EACnB,mBAAoB,EACpB,oBAAqB,EACrB,mBAAoB,GAXf,EAAe,cAAc,EAepC,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,OAAS,CAAA,CAER,eAAgB,EAAe,cAAc,CAC7C,cAAe,EAAM,EAAE,CACvB,QAAS,QAAW,EACpB,cAAe,IAAM,EAAW,MAChC,0BAA2B,EAC3B,oBAAqB,EACrB,YAAa,EAAU,EAAE,CACzB,cAAe,EAAU,IAAI,CAC7B,oBAAqB,EACrB,sBAAuB,EAAkB,cAAc,EAVlD,CAAC,MAAM,EAAE,EAAe,cAAc,CAAA,CAAE,KAejD,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,OAAiB,CAAA,CAEhB,OAAQ,EACR,QAAS,IAAM,GAAgB,GAC/B,eAAgB,EAAe,cAAc,CAC7C,UAAW,EACX,iBAAkB,EAClB,kBAvHwB,AAAC,CAuHN,GAtHvB,EAAa,GACb,aAAa,OAAO,CAAC,CAAC,eAAe,EAAE,EAAe,cAAc,CAAA,CAAE,CAAE,EAC1E,EAqHM,gBAAiB,EAAkB,eAAe,CAClD,YAAa,IAAM,EAAO,IAAI,CAAC,WAR1B,CAAC,SAAS,EAAE,EAAe,cAAc,CAAA,CAAE,KA3DlD,CAAA,EAAA,EAAA,GAAA,EAAC,MAAA,CAAI,UAAU,mDACb,CAAA,EAAA,EAAA,IAAA,EAAC,MAAA,CAAI,UAAU,wBACb,CAAA,EAAA,EAAA,GAAA,EAAC,IAAA,CAAE,UAAU,6BAAqB,GAAS,2BAC3C,CAAA,EAAA,EAAA,GAAA,EAAC,SAAA,CACC,QAAS,EACT,UAAU,yCACX,4BAiEX"}